# Caddyfile - Configuração do Caddy Server

# Redirecionamentos

www.labirintar.com.br {
    redir https://labirintar.com.br{uri} permanent
}

# Domínio: labirintar.com.br (Site principal)

labirintar.com.br {
    root * /var/www/sites/labirintar
    encode gzip zstd

    log {
        output file /var/log/caddy/labirintar-access.log
        format json
    }

    # Redireciona /blog para subdomínio
    handle_path /blog* {
        redir https://blog.labirintar.com.br{uri} permanent
    }

    # Site estático simples (HTML puro, sem SPA)
    file_server
    
    # Redireciona 404 para home
    handle_errors {
        @404 expression {http.error.status_code} == 404
        redir @404 / temporary
    }

    @static {
        path *.css *.js *.ico *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.ttf *.eot *.webp *.json
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    # Limites de tamanho de upload para WordPress
    request_body {
        max_size 100MB
    }

    # Bloqueia acesso a arquivos sensíveis do WordPress
    @blocked {
        path *.sql *.zip *.tar *.gz *.bak *wp-config.php* *.log
        path */xmlrpc.php
        path */.git/* */.svn/* */.env
    }
    respond @blocked 403

    # Health check endpoint
    handle /health {
        respond "OK" 200
    }
}

# Domínio: blog.labirintar.com.br (WordPress)

www.blog.labirintar.com.br {
    redir https://blog.labirintar.com.br{uri} permanent
}

blog.labirintar.com.br {
    encode gzip zstd

    log {
        output file /var/log/caddy/blog-access.log
        format json
    }

    # Reverse proxy para WordPress
    reverse_proxy wordpress:80 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        transport http {
            dial_timeout 10s
            response_header_timeout 30s
        }
    }

    # Headers de segurança
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    # Limites de tamanho de upload
    request_body {
        max_size 100MB
    }

    # Cache de arquivos estáticos
    @static {
        path *.css *.js *.ico *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.ttf *.eot *.webp
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # Bloqueia acesso a arquivos sensíveis
    @blocked {
        path *.sql *.zip *.tar *.gz *.bak *wp-config.php* *.log
        path */xmlrpc.php
        path */.git/* */.svn/* */.env
    }
    respond @blocked 403

    # Health check
    handle /health {
        respond "OK" 200
    }
}

# Domínio: new.labirintar.com.br

www.new.labirintar.com.br {
    redir https://new.labirintar.com.br{uri} permanent
}

new.labirintar.com.br {
    root * /var/www/sites/new-labirintar
    encode gzip zstd

    log {
        output file /var/log/caddy/new-labirintar-access.log
        format json
    }

    # Site estático simples (HTML puro, sem SPA)
    file_server

    @static {
        path *.css *.js *.ico *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.ttf *.eot *.webp *.json
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}


# Uptime Kuma - Monitoramento
status.labirintar.com.br {
    # Habilita HTTPS automático
    encode gzip zstd

    # Logs
    log {
        output file /var/log/caddy/status-access.log
        format json
    }

    # Reverse proxy para Uptime Kuma
    reverse_proxy uptime-kuma:3001 {
        # Headers WebSocket
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # Suporte a WebSocket (necessário para Uptime Kuma)
        header_up Connection {>Connection}
        header_up Upgrade {>Upgrade}
    }

    # Headers de segurança
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

# ============================================
# SITES ESTÁTICOS (React, Vue, Angular, etc)
# ============================================

# Exemplo: Site React/SPA
# Descomente e ajuste conforme necessário
# app.labirintar.com.br {
#     root * /var/www/sites/app
#     encode gzip zstd
#     
#     # Logs
#     log {
#         output file /var/log/caddy/app-access.log
#         format json
#     }
#     
#     # SPA: redireciona todas as rotas para index.html
#     try_files {path} /index.html
#     
#     # Serve arquivos
#     file_server
#     
#     # Cache de assets estáticos
#     @static {
#         path *.css *.js *.ico *.gif *.jpg *.jpeg *.png *.svg *.woff *.woff2 *.ttf *.eot *.webp *.json
#     }
#     header @static Cache-Control "public, max-age=31536000, immutable"
#     
#     # Headers de segurança
#     header {
#         X-Frame-Options "SAMEORIGIN"
#         X-Content-Type-Options "nosniff"
#         X-XSS-Protection "1; mode=block"
#         Referrer-Policy "strict-origin-when-cross-origin"
#         -Server
#     }
# }

# Exemplo: Site com API proxy
# landing.labirintar.com.br {
#     root * /var/www/sites/landing
#     encode gzip zstd
#     
#     # Proxy para API backend
#     handle /api/* {
#         reverse_proxy backend:3000
#     }
#     
#     # Serve arquivos estáticos
#     file_server
#     try_files {path} /index.html
# }

# Configuração para desenvolvimento local (opcional)
# Descomente se quiser testar localmente sem domínio
# localhost, 127.0.0.1 {
#     reverse_proxy wordpress:80
# }

